<form name="dynamicForm" [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" fxLayout="column"
  fxLayoutAlign="start center" class="noc-activity-form-container">
  <div class="noc-activity-form">
    @if (!noctuaUserService.user) {
    <div class="noc-draw-body-disabled" fxLayoutAlign="center center">
      Log in to Continue
    </div>
    }
    <div class="noc-form-section" fxLayout="column" fxLayoutAlign="start stretch">
      <div class="p-0 px-3 pt-1" fxLayout="row" fxLayoutAlign="start center">
        <noc-term-autocomplete fxFlex="35" class="mt-[24px] p-1" formControlName="gp"
          [label]="annotationActivity?.gp.label" [category]="annotationActivity?.gp.category"
          solrField="gp"></noc-term-autocomplete>
        <div class="p-1 " fxFlex="30" fxLayout="column" fxLayoutAlign="start stretch">
          <mat-checkbox class="noc-qualifier-cbx" formControlName="isComplement">NOT</mat-checkbox>
          <mat-form-field appearance="fill" class="noc-sm w-100-p" [attr.data-cy]="'form-input-gpterm-relation'">
            <mat-label>GP to Term Relation</mat-label>
            <mat-select class="" panelClass="noc-term-autocomplete" placeholder="" formControlName="gpToTermEdge"
              [compareWith]="compareFn">
              @for (item of annotationActivity?.gpToTermEdges; track item) {
              <mat-option [value]="item">
                <div class="w-100-p" fxLayout="row" fxLayoutAlign="start center">
                  <div class="noc-term-label">
                    {{ item.label }}
                  </div>
                  <span fxFlex></span>
                  <div class="noc-term-id">
                    @if (item.link) {
                    <a (click)="$event.stopPropagation()" href="{{item.link}}" target="_blank">
                      {{ item.id }}
                    </a>
                    }
                    @if (!item.link) {
                    <span>
                      {{ item.id }}
                    </span>
                    }
                  </div>
                </div>
              </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        <noc-term-autocomplete fxFlex="35" class="mt-[24px] p-1" formControlName="goterm"
          [label]="annotationActivity?.goterm.label" [category]="annotationActivity?.goterm.category"
          solrField="goterm"></noc-term-autocomplete>
      </div>

      <div class="noc-section-header pr-8" fxLayout="row" fxLayoutAlign="start center">
        <div class="noc-section-heading">
          Evidence
        </div>
        <span fxFlex></span>
      </div>
      <div formGroupName="evidence" class="p-0 px-3" fxLayout="row" fxLayoutAlign="start center">
        <noc-term-autocomplete fxFlex="35" class="p-1" formControlName="evidenceCode"
          [label]="annotationActivity?.evidence?.evidenceCode.label"
          [category]="annotationActivity?.evidence?.evidenceCode.category"
          solrField="evidenceCode"></noc-term-autocomplete>
        <noc-term-autocomplete fxFlex="30" class="p-1" formControlName="reference"
          [autocompleteType]="AutocompleteType.REFERENCE" [label]="annotationActivity?.evidence?.reference.label"
          solrField="reference"></noc-term-autocomplete>
        <noc-term-autocomplete fxFlex="35" class="p-1" formControlName="withFrom"
          [label]="annotationActivity?.evidence?.with.label" solrField="withFrom"></noc-term-autocomplete>
      </div>
      <div class="noc-section-header pr-4" fxLayout="row" fxLayoutAlign="start center">
        <div class="noc-section-heading">
          Extensions
        </div>
        <span fxFlex></span>
        <!--  <button mat-stroked-button (click)="addExtension()" type="submit" class="noc-xs noc-rounded-button"
          color="primary">
          Add
        </button> -->
      </div>
      <div formArrayName="annotationExtensions" class="px-3 pt-1" fxLayout="column" fxLayoutAlign="start center">
        <div *ngFor="let item of annotationExtensions.controls; let i=index" [formGroupName]="i" class="w-100-p">
          <div class="p-1" fxFlex="35" fxLayout="column" fxLayoutAlign="start stretch">
            <mat-form-field appearance="fill" class="noc-sm w-100-p" [attr.data-cy]="'form-input-extension-relation'">
              <mat-label>Extension Relation</mat-label>
              <mat-select class="" panelClass="noc-term-autocomplete" placeholder="" formControlName="extensionEdge"
                [compareWith]="compareFn">
                @for (item of annotationActivity?.extensions[i]?.extensionEdges; track item) {
                <mat-option [value]="item">
                  <div class="w-100-p" fxLayout="row" fxLayoutAlign="start center">
                    <div class="noc-term-label">
                      {{ item.label }}
                    </div>
                    <span fxFlex></span>
                    <div class="noc-term-id">
                      @if (item.link) {
                      <a (click)="$event.stopPropagation()" href="{{item.link}}" target="_blank">
                        {{ item.id }}
                      </a>
                      }
                      @if (!item.link) {
                      <span>
                        {{ item.id }}
                      </span>
                      }
                    </div>
                  </div>
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
          <noc-term-autocomplete fxFlex="" class="p-1" formControlName="extensionTerm"
            [label]="annotationActivity?.extensions[i]?.extensionTerm.label"
            [category]="annotationActivity?.extensions[i]?.extensionTerm?.category"
            solrField="extensionTerm"></noc-term-autocomplete>
          <button mat-icon-button (click)="deleteExtension(i)" class="text-warn">
            <fa-icon [icon]="['far', 'trash-alt']"></fa-icon>
          </button>
        </div>
      </div>

      <button mat-stroked-button (click)="addExtension()" type="submit" class="noc-xs noc-rounded-button"
        color="primary">
        Add @if(annotationActivity?.extensions.length>1) {<span>Another</span>}Extension
      </button>
      <div fxLayout="row" fxLayoutAlign="start center" class="noc-drawer-footer noc-submit-row">
        @if (hasErrors()) {
        <button (click)='checkErrors()' mat-button color="warn" class="noc-rounded-button noc-sm">
          Why is the "Save" button disabled?
        </button>
        }
        <span fxFlex></span>
        <button (click)='clear()' type="button" mat-stroked-button color="" class="mr-8">Clear</button>
        <button [disabled]="hasErrors()" (click)="save()" type="submit" class="" mat-stroked-button color="primary"
          [attr.data-cy]="'save-annotation-button'">Save</button>
      </div>
    </div>
  </div>
</form>