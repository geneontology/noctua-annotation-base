<div class="w-100-p">
  <div [attr.id]="annoton.displayId" class="w-100-p"
    [ngClass]="{'noc-selected': annoton.displayId===camsService.currentMatch?.annotonDisplayId}">
    <div class="noc-annoton-table-heading" fxLayout="row" fxLayoutAlign="start center">
      <div fxFlex="25px" (click)="$event.stopPropagation()">
        <button mat-icon-button (click)="toggleExpand(annoton)" color="primary" class="noc-toggle-expand-button">
          <fa-icon *ngIf="!annoton.expanded" [icon]="['fas', 'caret-right']"></fa-icon>
          <fa-icon *ngIf="annoton.expanded" [icon]="['fas', 'caret-down']"></fa-icon>
        </button>
      </div>
      <div class="noc-display-number noc-sm mr-8" (click)="$event.stopPropagation()">
        {{annoton.displayNumber}}
      </div>
      <div class="noc-title  mr-12" fxLayout="row" fxLayoutAlign="start center">
        <div class="noc-relationship mr-12"> <small>{{gpNode?.predicate?.edge?.label}}</small> </div>
        <div class="noc-gp" *ngIf="gpNode" [attr.id]="gpNode.term?.displayId" [ngClass]="{'noc-highlight-match': gpNode.term?.highlight,
        'noc-highlight-modified': gpNode.term?.modified,
        'noc-highlight-match-current': gpNode.term?.uuid===camsService.currentMatch?.uuid}" fxLayout="column"
          fxLayoutAlign="center start">
          <p class="noc-old-term text-truncate" *ngIf="gpNode.term?.modified && gpNode.term?.termHistory?.length>0">
            {{gpNode.term?.termHistory[0]?.label}}
            <a (click)="$event.stopPropagation()" href="{{gpNode.term?.termHistory[0]?.url}}" target="_blank">
              {{ gpNode.term?.termHistory[0]?.id }}
            </a>
          </p>
          <p class="text-truncate">
            {{gpNode.term?.label}}
          </p>
          <a class="text-truncate" (click)="$event.stopPropagation()" href="{{gpNode.term?.url}}" target="_blank">
            {{ gpNode.term?.id }}
          </a>
          <noctua-inline-editor *ngIf="noctuaUserService.user && gpNode.term && options.editableTerms" [cam]="cam"
            [annoton]='annoton' [entity]="gpNode" [category]="EditorCategory.term" class="noc-edit-button">
          </noctua-inline-editor>
        </div>
      </div>
      <mat-chip class="noc-chip-xs" [ngClass]="annoton.annotonType">
        <span>{{annotonTypeOptions[annoton.annotonType]?.label}}</span>
      </mat-chip>
      <div *ngIf="annoton.hasViolations" class="noc-error" fxLayout="row" fxLayoutAlign="start center">
        <mat-chip class="noc-error-chip" fxLayout="row" fxLayoutAlign="start center"
          (click)="displayAnnotonErrors(annoton)">
          <div class="noc-icon">
            <fa-icon [icon]="['fas', 'exclamation-triangle']"></fa-icon>
          </div>
          <div fxFlex="" class="noc-chip-label">
            {{annoton.violations?.length}} Errors Found
          </div>
        </mat-chip>
      </div>
      <span fxFlex=""></span>
      <!--
    <div *ngIf="!options.reviewMode" class="" fxFlex="200px" fxLayout="row" fxLayoutAlign="end center">
      <button *ngIf="annoton.annotonType !==AnnotonType.ccOnly" mat-stroked-button
        (click)="openAnnotonConnector(annoton)" color="primary" class="noc-rounded-button noc-sm mr-8"
        matTooltip="connect activity causal relation" [matTooltipPosition]="'after'" [matTooltipShowDelay]="1500">
        <small>Connect</small>
      </button>
       <button mat-stroked-button (click)="openAnnotonForm(annoton)" color="primary"
        class="noc-rounded-button noc-sm mr-8">
        <small>Edit</small>
      </button> 
      <button mat-icon-button class="noc-rounded-button noc-sm" fxFlex="40px" color="primary"
        [matMenuTriggerFor]="connectionOptionMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #connectionOptionMenu="matMenu" class="noc-dropdown-menu">
        <h6 class="noc-menu-heading"> Danger Zone</h6>
        <button mat-menu-item class="" (click)="deleteAnnoton(annoton)">
          Delete Activity
        </button>
      </mat-menu>
     
    </div>-->
    </div>
  </div>






  <div *ngIf="annoton.expanded" class="noc-annoton-table w-100-p"
    [ngClass]="{'noc-selected': annoton.displayId===camsService.currentMatch?.annotonDisplayId}" fxLayout="column"
    fxLayoutAlign="start start">
    <table mat-table fxFlex="1 1 auto" class="" [dataSource]="annoton.nodes" [@animateStagger]="{value:'50'}">
      <ng-container matColumnDef="relationship" sticky>
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">Relationship
        </th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px" sticky>
          <p class="">
            <strong> {{entity.qualifier}} </strong>
            {{entity.relationship}}
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && entity.relationEditable && !options.reviewMode"
            [cam]="cam" [annoton]='annoton' [entity]="entity" [category]="EditorCategory.relationship"
            class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="aspect" sticky>
        <th mat-header-cell *matHeaderCellDef fxFlex="30px" fxLayout="row" fxLayoutAlign="start center">Asp</th>
        <td mat-cell *matCellDef="let entity" fxFlex="30px">
          <p class="">{{entity.aspect}}</p>
        </td>
      </ng-container>
      <ng-container matColumnDef="term">
        <th mat-header-cell *matHeaderCellDef class="noc-column-flex" fxFlex="" fxLayout="row"
          fxLayoutAlign="start center">Term</th>
        <td mat-cell class="noc-column-flex" *matCellDef="let entity" fxFlex="" fxLayout="row"
          fxLayoutAlign="start center" [attr.id]="entity.term?.displayId" [ngClass]="{'noc-highlight-match': entity.term?.highlight,
            'noc-highlight-modified': entity.term?.modified,
            'noc-highlight-match-current': entity.term?.uuid===camsService.currentMatch?.uuid}">
          <p class="noc-old-term" *ngIf="entity.term?.modified && entity.term?.termHistory?.length>0">
            {{entity.term?.termHistory[0]?.label}}
            <a (click)="$event.stopPropagation()" href="{{entity.term?.termHistory[0]?.url}}" target="_blank">
              {{ entity.term?.termHistory[0]?.id }}
            </a>
          </p>
          <p class="">
            {{entity.term?.label}} <br>
            <a (click)="$event.stopPropagation()" href="{{entity.term?.url}}" target="_blank">
              {{ entity.term?.id }}
            </a>
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && entity.term && options.editableTerms" [cam]="cam"
            [annoton]='annoton' [entity]="entity" [category]="EditorCategory.term" class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="relationshipExt">
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">Relationship
          (ext)</th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px">
          <p class="">{{entity.relationshipExt}}</p>
        </td>
      </ng-container>
      <ng-container matColumnDef="extension">
        <th mat-header-cell *matHeaderCellDef fxFlex="150px" fxLayout="row" fxLayoutAlign="start center">Extension
        </th>
        <td mat-cell *matCellDef="let entity" [attr.id]="entity.extension?.displayId" fxFlex="150px" fxLayout="row"
          fxLayoutAlign="start center" [ngClass]="{'noc-highlight-match': entity.extension?.highlight,
            'noc-highlight-modified': entity.extension?.modified,
            'noc-highlight-match-current': entity.extension?.uuid===camsService.currentMatch?.uuid}">
          <p class="noc-old-term" *ngIf="entity.extension?.modified && entity.extension?.termHistory?.length>0">
            {{entity.extension?.termHistory[0]?.label}}
            <a (click)="$event.stopPropagation()" href="{{entity.extension?.termHistory[0]?.url}}" target="_blank">
              {{ entity.extension?.termHistory[0]?.id }}
            </a>
          </p>
          <p class="">{{entity.extension?.label}} <br>
            <a (click)="$event.stopPropagation()" href="{{entity.extension?.url}}" target="_blank">
              {{ entity.extension?.id }}
            </a>
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && entity.extension && options.editableTerms" [cam]="cam"
            [annoton]='annoton' [entity]="entity" [category]="EditorCategory.term" class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="evidence">
        <th mat-header-cell *matHeaderCellDef class="noc-column-flex" fxFlex="" fxLayout="row"
          fxLayoutAlign="start center">Evidence</th>
        <td mat-cell *matCellDef="let entity" class="noc-column-flex" fxFlex="" fxLayout="row"
          fxLayoutAlign="start center" [ngClass]="{'noc-highlight-modified': entity.predicate?.evidence?.modified}">
          <p class="noc-old-term"
            *ngIf="entity.predicate?.evidence?.modified && entity.predicate?.evidence?.termHistory?.length>0">
            {{entity.predicate?.evidence?.termHistory[0]?.label}}
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.evidence?.termHistory[0]?.url}}"
              target="_blank">
              {{ entity.predicate?.evidence?.termHistory[0]?.id }}
            </a>
          </p>
          <p class="">{{entity.predicate?.evidence?.label}}<br>
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.evidence?.url}}" target="_blank">
              {{ entity.predicate?.evidence?.id }}
            </a>
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && options.editableEvidence" [cam]="cam"
            [annoton]='annoton' [entity]="entity" [category]="EditorCategory.evidence"
            [evidenceIndex]="entity.predicate?.evidenceIndex" class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="reference">
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">Reference
        </th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px" fxLayout="row" fxLayoutAlign="start center" [ngClass]="{'noc-highlight-match': entity.predicate?.referenceEntity?.highlight,
          'noc-highlight-modified': entity.predicate?.referenceEntity?.modified,
          'noc-highlight-match-current': entity.predicate?.referenceEntity?.uuid===camsService.currentMatch?.uuid}">
          <p class="noc-old-term"
            *ngIf="entity.predicate?.referenceEntity?.modified && entity.predicate?.referenceEntity?.termHistory?.length>0">
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.referenceEntity?.termHistory[0]?.url}}"
              target="_blank">
              {{ entity.predicate?.referenceEntity?.termHistory[0]?.id }}
            </a>
          </p>
          <p *ngIf="!entity.predicate?.referenceEntity?.url" class="">{{entity.predicate?.reference}}</p>
          <p *ngIf="entity.predicate?.referenceEntity?.url" class="">
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.referenceEntity?.url}}" target="_blank">
              {{entity.predicate?.reference}}
            </a>
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && options.editableReference" [cam]="cam"
            [annoton]='annoton' [entity]="entity" [category]="EditorCategory.reference"
            [evidenceIndex]="entity.predicate?.evidenceIndex" class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="with">
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">With</th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px" fxLayout="row" fxLayoutAlign="start center"
          [ngClass]="{'noc-highlight-modified': entity.predicate?.withEntity?.modified}">
          <p class="noc-old-term"
            *ngIf="entity.predicate?.withEntity?.modified && entity.predicate?.withEntity?.termHistory?.length>0">
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.withEntity?.termHistory[0]?.url}}"
              target="_blank">
              {{ entity.predicate?.withEntity?.termHistory[0]?.id }}
            </a>
          </p>
          <p *ngIf="!entity.predicate?.withEntity?.url" class="">{{entity.predicate?.with}}</p>
          <p *ngIf="entity.predicate?.withEntity?.url" class="">
            <a (click)="$event.stopPropagation()" href="{{entity.predicate?.withEntity?.url}}" target="_blank">
              {{entity.predicate?.with}}
            </a>
          </p>
          <noctua-inline-editor *ngIf="noctuaUserService.user && options.editableWith" [cam]="cam" [annoton]='annoton'
            [entity]="entity" [category]="EditorCategory.with" [evidenceIndex]="entity.predicate?.evidenceIndex"
            class="noc-edit-button">
          </noctua-inline-editor>
        </td>
      </ng-container>
      <ng-container matColumnDef="assignedBy">
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">Assigned By
        </th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">
          <p class="">
            <span *ngFor="let group of entity.groups; let i=index; let isLast=last">
              <a (click)="$event.stopPropagation()" href="{{group.url}}" target="_blank">
                {{group.name}}
              </a>
              <span *ngIf="!isLast">&#44;&nbsp;</span>
            </span>
          </p>
        </td>
      </ng-container>
      <ng-container matColumnDef="contributor">
        <th mat-header-cell *matHeaderCellDef fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">Contributors
        </th>
        <td mat-cell *matCellDef="let entity" fxFlex="120px" fxLayout="row" fxLayoutAlign="start center">
          <p class="">
            <span *ngFor="let contributor of entity.contributors; let i=index; let isLast=last">
              <a (click)="$event.stopPropagation()" href="{{contributor.urcid}}" target="_blank">
                {{contributor.name}}
              </a>
              <span *ngIf="!isLast">&#44;&nbsp;</span>
            </span>
          </p>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions" stickyEnd>
        <th mat-header-cell *matHeaderCellDef fxFlex="50px" fxLayout="row" fxLayoutAlign="start center"></th>
        <td mat-cell *matCellDef="let entity" fxFlex="50px" fxLayout="row" fxLayoutAlign="start center">
          <span fxFlex=""></span>
          <button mat-icon-button *ngIf="noctuaUserService.user" (click)="updateCurrentMenuEvent($event)"
            class="noc-action-button" fxFlex="40px" [matMenuTriggerFor]="entityMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #entityMenu="matMenu" class="noc-dropdown-menu">
            <button mat-menu-item *ngIf="entity.treeLevel===0" class="" (click)="toggleIsComplement(entity)">
              NOT Qualifier
            </button>
            <button mat-menu-item *ngIf="entity.insertMenuNodes" [matMenuTriggerFor]="addMenu">Add</button>
            <button mat-menu-item [matMenuTriggerFor]="evidenceMenu">Evidence</button>
          </mat-menu>
          <mat-menu #addMenu="matMenu">
            <button mat-menu-item *ngFor="let insertMenuItem of entity.insertMenuNodes" class=""
              (click)="insertEntity(entity, insertMenuItem)">
              {{insertMenuItem.label}}
            </button>
          </mat-menu>
          <mat-menu #evidenceMenu="matMenu">
            <button mat-menu-item (click)="addEvidence(entity, entity.predicate?.evidenceIndex)" class="">
              Add Evidence
            </button>
            <!--   <button (click)="removeEvidence(entity,i)" mat-menu-item>
                Remove Evidence
              </button> -->
          </mat-menu>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let entity; columns: displayedColumns;" class="" matRipple [ngClass]="{'noc-row-term': entity.term,
          'noc-row-selected': entity.uuid === noctuaAnnotonEntityService.termNode?.uuid}"></tr>
    </table>
    <div *ngIf="grid?.length===0" class="noc-no-info">
      no results yet.
    </div>
  </div>
</div>